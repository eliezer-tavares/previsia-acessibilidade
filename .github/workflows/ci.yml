name: CI - Build e Check App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        playwright install --with-deps

    - name: Lint code (check formatting with black)
      run: |
        pip install black
        black --check .

    - name: Run app test (check if starts) - BULLETPROOF VERSION
      run: |
        echo "Starting Flask app in background..."
        python app.py &> app.log &
        APP_PID=$!
        echo "App started with PID $APP_PID. Waiting 30 seconds..."
        sleep 30

        echo "--- Checking server response with curl ---"
        # Usamos -f para falhar em erros HTTP, e guardamos o código de saída
        curl -f -v http://localhost:10000/
        CURL_EXIT_CODE=$?
        echo "Curl finished with exit code: $CURL_EXIT_CODE"

        echo "--- Displaying full app.log for debugging ---"
        # Usamos 'cat' para ver o log inteiro, não só o final
        cat app.log

        echo "--- Attempting to stop the application process ---"
        # O comando 'kill' agora é à prova de falhas. 
        # Se o processo já morreu, ele não vai quebrar o CI.
        kill $APP_PID || echo "Process with PID $APP_PID was already gone. Ignoring error."

        # O sucesso do passo depende APENAS do sucesso do curl.
        exit $CURL_EXIT_CODE

    - name: Run pytest (if tests added later)
      run: |
        pip install pytest
        pytest
